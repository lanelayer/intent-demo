<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swap BTC ‚Üí LaneBTC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        .info-box {
            background: #f3f4f6;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .info-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .info-value {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            font-size: 13px;
        }
        .qr-code {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }
        .qr-code canvas {
            max-width: 100%;
            height: auto !important;
        }
        .bitcoin-uri {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .bitcoin-uri:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .offer-card {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .offer-card h3 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        .offer-details {
            color: #475569;
            margin: 10px 0;
        }
        .hidden { display: none !important; }
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .action-grid { grid-template-columns: 1fr; }
        }
        .action-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .action-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        .action-card p {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }
        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin: 15px 0;
        }
        .loading-steps {
            text-align: left;
            max-width: 400px;
            margin: 20px auto;
            color: #666;
        }
        .loading-steps div {
            padding: 8px 0;
            display: flex;
            align-items: center;
        }
        .loading-steps .step-done {
            color: #10b981;
        }
        .loading-steps .step-active {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Swap BTC ‚Üí LaneBTC</h1>
            <p class="subtitle">
                Trustless Bitcoin bridge to LaneLayer Core Layer
            </p>
        </div>

        <!-- Step 1: Swap Input + Quotes -->
        <div class="card" id="step-swap">
            <h2>Swap</h2>
            
            <!-- From -->
            <div style="margin-bottom: 20px;">
                <label>From</label>
                <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: #6b7280; font-size: 14px;">You pay</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; font-size: 16px;">‚ö° BTC</span>
                        </div>
                    </div>
                    <input type="number" id="btc-amount" placeholder="0.0005" step="0.00001" value="0.0005"
                           style="font-size: 32px; font-weight: 600; border: none; background: transparent; padding: 0; width: 100%;"
                           oninput="updateQuotes()">
                    <div style="color: #9ca3af; font-size: 14px; margin-top: 8px;">
                        Network: <strong>Bitcoin Regtest</strong>
                    </div>
                </div>
            </div>

            <!-- Swap Arrow -->
            <div style="text-align: center; margin: -10px 0;">
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 50%; width: 40px; height: 40px; 
                            display: inline-flex; align-items: center; justify-content: center; cursor: pointer;"
                     onclick="alert('Reverse swap not yet implemented')">
                    <span style="font-size: 20px;">‚¨áÔ∏è</span>
                </div>
            </div>

            <!-- To -->
            <div style="margin-top: 20px; margin-bottom: 20px;">
                <label>To (Best Rate)</label>
                <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: #6b7280; font-size: 14px;">You receive</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; font-size: 16px;">üåä LaneBTC</span>
                        </div>
                    </div>
                    <div style="font-size: 32px; font-weight: 600; color: #1e40af;" id="lanebtc-amount">0.00045</div>
                    <div style="color: #3b82f6; font-size: 14px; margin-top: 8px;">
                        Destination: <strong>LaneLayer Core Layer</strong>
                    </div>
                </div>
            </div>

            <!-- Solver Quote -->
            <div style="margin-top: 30px;">
                <h3 style="font-size: 16px; color: #374151; margin-bottom: 15px;">Solver</h3>
                <div id="quotes-list">
                    <!-- Quote will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Step 3: Escrow Address -->
        <div class="card hidden" id="step-address">
            <h2>Fund Escrow</h2>
            
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Solver</div>
                        <div style="font-weight: 600; color: #1e40af;" id="solver-name">-</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">You'll receive</div>
                        <div style="font-weight: 600; color: #1e40af;"><span id="lanebtc-receive">-</span> LaneBTC</div>
                    </div>
                </div>
            </div>

            <p style="color: #666; margin-bottom: 15px;">
                Send <strong id="send-amount">- BTC</strong> to the escrow address below
            </p>
            
            <div style="text-align: center; margin: 20px 0;">
                <a href="#" id="bitcoin-uri-link" class="bitcoin-uri">
                    üì± Open in Bitcoin Wallet
                </a>
            </div>
            
            <!-- QR Code + Waiting Spinner Side by Side -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 30px; margin: 30px 0; flex-wrap: wrap;">
                <!-- QR Code -->
                <div class="qr-code" id="qr-container" style="margin: 0;">
                    <!-- QR code will be generated here -->
                </div>
                
                <!-- Waiting Indicator -->
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <div class="loading-text" style="margin-top: 15px;">Waiting for deposit...</div>
                    <div style="color: #6b7280; font-size: 14px; margin-top: 10px; max-width: 200px;">
                        Watching Bitcoin network for incoming transaction
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <div class="info-label">Escrow Address</div>
                <div class="info-value" id="escrow-address" style="font-size: 14px; font-weight: 600;"></div>
            </div>
            
            <div class="info-box" style="background: #fef3c7; border-left-color: #f59e0b;">
                <div style="font-weight: 600; color: #92400e; margin-bottom: 10px;">
                    üíª Bitcoin CLI Command
                </div>
                <code id="cli-command" style="background: white; padding: 8px; display: block; border-radius: 4px; word-break: break-all;"></code>
            </div>
        </div>

        <!-- Step 3.5: Preparing Escrow (Loading) -->
        <div class="card hidden" id="step-loading">
            <h2>‚öôÔ∏è Preparing Escrow</h2>
            <div class="spinner"></div>
            <div class="loading-text">Collaborating with solver...</div>
            <div class="loading-steps">
                <div id="load-step-1">‚è≥ Verifying funding transaction...</div>
                <div id="load-step-2">‚è≥ Generating MuSig2 nonces...</div>
                <div id="load-step-3">‚è≥ Creating presigned burn transaction...</div>
                <div id="load-step-4">‚è≥ Finalizing escrow setup...</div>
            </div>
        </div>

        <!-- Step 4: Waiting for Solver -->
        <div class="card hidden" id="step-waiting">
            <h2>Waiting for Solver</h2>
            <div class="spinner"></div>
            <div class="loading-text">Solver is fulfilling your swap...</div>
            <div style="text-align: center; color: #666; font-size: 14px; margin-top: 10px;">
                This usually takes a few minutes
            </div>
        </div>

        <!-- Step 5: Delivery Confirmation -->
        <div class="card hidden" id="step-delivery">
            <h2>Delivery Complete</h2>
            
            <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <div style="font-size: 18px; font-weight: 600; color: #065f46; margin-bottom: 8px;">
                    LaneBTC Received!
                </div>
                <div style="font-size: 32px; font-weight: 700; color: #10b981; margin: 10px 0;" id="delivered-amount">
                    0.00040 LaneBTC
                </div>
                <div style="font-size: 14px; color: #059669;">
                    has been registered in your LaneLayer account
                </div>
            </div>

            <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 4px; margin: 20px 0;">
                <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                    ‚ö†Ô∏è Important: Confirm Delivery
                </div>
                <div style="color: #78350f; font-size: 14px;">
                    Do you agree that the solver has successfully delivered <strong id="delivered-amount-2">0.00040 LaneBTC</strong> to your LaneLayer account?
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <button class="btn btn-success" onclick="completeDelivery()">‚úì Yes, Complete Delivery</button>
                <button class="btn btn-danger" onclick="showDispute()">‚úó No, Dispute</button>
            </div>
        </div>

        <!-- Step 6: Escrow Active - Action Options -->
        <div class="card hidden" id="step-actions">
            <h2>Escrow Active - Advanced Actions</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Your funds are held in escrow. Additional actions:
            </p>
            
            <div class="action-grid">
                <!-- Option 1: Burn -->
                <div class="action-card" style="border-color: #f59e0b;">
                    <h3 style="color: #f59e0b;">üî• Dispute / Burn</h3>
                    <p>Reveal intent on-chain and burn the UTXO (requires both signatures)</p>
                    <button class="btn btn-warning" onclick="showBurnTx()">Show Burn TX</button>
                </div>
                
                <!-- Option 2: Payout -->
                <div class="action-card" style="border-color: #10b981;">
                    <h3 style="color: #10b981;">‚úÖ Happy Path</h3>
                    <p>Solver delivered! Sign cooperative payout (requires solver)</p>
                    <button class="btn btn-success" onclick="cooperativePayout()">Complete Delivery</button>
                </div>
                
                <!-- Option 3: Refund -->
                <div class="action-card" style="border-color: #ef4444;">
                    <h3 style="color: #ef4444;">‚è±Ô∏è Force Refund</h3>
                    <div class="countdown" id="refund-countdown">144 blocks</div>
                    <p>Unilateral refund available after timelock</p>
                    <button class="btn btn-danger" id="btn-refund" onclick="forceRefund()" disabled>Force Refund</button>
                </div>
            </div>
        </div>

        <!-- Burn TX Modal -->
        <div class="card hidden" id="burn-result">
            <h2>üî• Burn Transaction Ready</h2>
            <p style="color: #666; margin-bottom: 15px;">
                This transaction burns the UTXO and reveals your intent on-chain (signed with ANYONECANPAY)
            </p>
            
            <div class="info-box">
                <div class="info-label">Transaction Hex</div>
                <div style="position: relative;">
                    <div class="info-value" id="burn-hex" style="max-height: 150px; overflow-y: auto;"></div>
                    <button onclick="copy('burn-hex')" 
                            style="position: absolute; top: 8px; right: 8px; background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üìã Copy
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <div class="info-label">TXID</div>
                <div class="info-value" id="burn-txid"></div>
            </div>
            
            <div class="info-box">
                <div class="info-label">Details</div>
                <div class="info-value">
                    Format: BTI1 (Burn-to-Intent v1)<br>
                    Intent Hash: <span id="burn-intent-hash"></span><br>
                    Burn Amount: <span id="burn-amount"></span> sats<br>
                    Destination: LaneLayer Core Layer<br>
                    Sighash: ALL|ANYONECANPAY (fee-payer can add inputs)
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <strong style="color: #0369a1;">üì° Broadcast Command:</strong><br>
                <code style="background: white; padding: 8px; display: block; margin-top: 8px; border-radius: 4px; word-break: break-all;" id="burn-broadcast"></code>
            </div>
            
            <button class="btn" style="margin-top: 15px; background: #6b7280;" onclick="document.getElementById('burn-result').classList.add('hidden')">‚Üê Back to Options</button>
        </div>

        <!-- Payout Result -->
        <div class="card hidden" id="payout-result">
            <h2>‚úÖ Cooperative Payout Ready</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Both parties have signed the payout transaction (happy path - solver delivered!)
            </p>
            
            <div class="info-box">
                <div class="info-label">Transaction Hex</div>
                <div style="position: relative;">
                    <div class="info-value" id="payout-hex" style="max-height: 150px; overflow-y: auto;"></div>
                    <button onclick="copy('payout-hex')" 
                            style="position: absolute; top: 8px; right: 8px; background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üìã Copy
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <div class="info-label">TXID</div>
                <div class="info-value" id="payout-txid"></div>
            </div>
            
            <div class="info-box">
                <div class="info-label">Details</div>
                <div class="info-value">
                    Type: Cooperative Payout (MuSig2 key-path)<br>
                    Payout Amount: <span id="payout-amount"></span> sats<br>
                    Sighash: ALL (SIGHASH_DEFAULT)<br>
                    Witness: 64-byte Schnorr signature
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <strong style="color: #0369a1;">üì° Broadcast Command:</strong><br>
                <code style="background: white; padding: 8px; display: block; margin-top: 8px; border-radius: 4px; word-break: break-all;" id="payout-broadcast"></code>
            </div>
            
            <button class="btn" style="margin-top: 15px; background: #6b7280;" onclick="document.getElementById('payout-result').classList.add('hidden'); document.getElementById('step-actions').classList.remove('hidden');">‚Üê Back to Options</button>
        </div>

        <!-- Refund Result -->
        <div class="card hidden" id="refund-result">
            <h2>‚è±Ô∏è Unilateral Refund</h2>
            <p style="color: #666; margin-bottom: 15px;">
                After 144 blocks, you can refund unilaterally (no solver signature needed)
            </p>
            <div class="info-box" style="background: #fee2e2; border-left-color: #ef4444;">
                <strong>‚ö†Ô∏è Timelock not expired!</strong><br>
                The CSV refund path is only available after 144 blocks from funding confirmation.
                This prevents immediate refunds and gives the solver time to fulfill the intent.
            </div>
            <div class="info-box">
                <div class="info-label">How it works:</div>
                <div style="font-size: 14px; color: #475569;">
                    After the timelock expires, you sign the refund transaction using only YOUR key (script-path spend via CSV leaf).
                    No cooperation from the solver required!
                </div>
            </div>
            <button class="btn" style="background: #6b7280;" onclick="document.getElementById('refund-result').classList.add('hidden')">‚Üê Back</button>
        </div>
    </div>

    <script type="module">
        import init, * as wasm from './wasm_helper/wasm_helper.js';

        const CHAIN_ID = 1; // LaneLayer uses chain_id for BTI1 format on-chain

        let state = {
            helper: null,
            intent: null,
            intentHash: null,
            swapAmount: null,
            escrowAmountSats: null,
            quotes: [],
            selectedQuote: null,
            userKeys: null,
            solverKeys: null,
            addressInfo: null,
            fundingTxid: null,
            fundingVout: null,
        };

        async function loadWasm() {
            try {
                await init();
                state.helper = new wasm.MuSig2Helper();
                const version = wasm.getWasmVersion();
                console.log('‚úÖ WASM loaded -', version);
            } catch (e) {
                console.error('Failed to load WASM:', e);
                alert('Failed to load WASM: ' + e.message);
            }
        }

        // Simple SHA-256 implementation for non-secure contexts
        async function sha256(str) {
            // If crypto.subtle is available (HTTPS/localhost), use it
            if (window.crypto && window.crypto.subtle) {
                const encoder = new TextEncoder();
                const data = encoder.encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                return Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            
            // Fallback: simple deterministic hash for demo purposes
            // In production, this should use a proper SHA-256 library
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            // Generate 32 bytes (64 hex chars) from the hash
            let result = '';
            let seed = Math.abs(hash);
            for (let i = 0; i < 64; i++) {
                seed = (seed * 1103515245 + 12345) & 0x7fffffff;
                result += (seed % 16).toString(16);
            }
            return result;
        }

        // Update LaneBTC amount and quotes as user types
        window.updateQuotes = function() {
            const btcAmount = parseFloat(document.getElementById('btc-amount').value) || 0;
            
            if (btcAmount <= 0) {
                document.getElementById('lanebtc-amount').textContent = '0.00000';
                document.getElementById('quotes-list').innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 40px;">Enter an amount to see quotes</div>';
                return;
            }

            if (btcAmount < 0.0001) {
                document.getElementById('lanebtc-amount').textContent = '0.00000';
                document.getElementById('quotes-list').innerHTML = '<div style="text-align: center; color: #ef4444; padding: 40px;">Minimum swap: 0.0001 BTC</div>';
                return;
            }

            // LaneLayer solver quote
            const quotes = [
                {
                    id: 1,
                    solver: 'LaneLayer',
                    rate: 1.0,
                    fee: 0.0001,
                    receives: (btcAmount - 0.0001).toFixed(5),
                    timelock: 144,
                    speed: 'Standard',
                    reputation: 100,
                },
            ];

            // Update best rate display (cheapest fee)
            const bestQuote = quotes.reduce((best, q) => q.fee < best.fee ? q : best, quotes[0]);
            document.getElementById('lanebtc-amount').textContent = bestQuote.receives;

            // Display quotes
            const quotesList = document.getElementById('quotes-list');
            quotesList.innerHTML = quotes.map(q => `
                <div class="offer-card" style="cursor: pointer; transition: all 0.2s;" 
                     onclick="acceptQuote(${q.id})"
                     onmouseover="this.style.transform='scale(1.02)'"
                     onmouseout="this.style.transform='scale(1)'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0;">${q.solver}</h3>
                            <div style="display: flex; gap: 8px; margin-top: 4px;">
                                <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${q.speed}
                                </span>
                                <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${q.reputation}% Rep
                                </span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: 700; color: #1e40af;">${q.receives}</div>
                            <div style="font-size: 12px; color: #6b7280;">LaneBTC</div>
                        </div>
                    </div>
                    <div class="offer-details">
                        <div style="display: flex; justify-content: space-between; margin: 6px 0;">
                            <span>Fee:</span>
                            <strong>${q.fee} BTC</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 6px 0;">
                            <span>Refund Timelock:</span>
                            <strong>${q.timelock} blocks (~${Math.floor(q.timelock / 144)} day)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 6px 0;">
                            <span>Destination:</span>
                            <strong>LaneLayer Core Layer</strong>
                        </div>
                    </div>
                </div>
            `).join('');

            // Store quotes in state
            state.quotes = quotes;
            state.swapAmount = btcAmount;
            
            // Generate intent hash from swap parameters
            const intent = `swap:${btcAmount}:BTC->LaneBTC`;
            sha256(intent).then(fullHash => {
                state.intentHash = fullHash.substring(0, 40); // First 20 bytes
                state.intent = intent;
            });
            
            console.log('üìä Updated', quotes.length, 'quotes for', btcAmount, 'BTC');
        };

        window.acceptQuote = async function(quoteId) {
            const quote = state.quotes.find(q => q.id === quoteId);
            if (!quote) return;

            console.log('‚úÖ Accepted quote from', quote.solver);
            state.selectedQuote = quote;
            state.swapAmount = parseFloat(document.getElementById('btc-amount').value);
            
            // Generate intent hash if not already done
            if (!state.intentHash) {
                const intent = `swap:${state.swapAmount}:BTC->LaneBTC`;
                const fullHash = await sha256(intent);
                state.intentHash = fullHash.substring(0, 40);
                state.intent = intent;
            }
            console.log('Generating keys and address...');
            
            // Generate ephemeral keypairs
            const userSk = state.helper.generateKeypair();
            const solverSk = state.helper.generateKeypair();
            
            state.userKeys = { sk: userSk };
            state.solverKeys = { sk: solverSk };
            
            const userSkHex = Array.from(userSk).map(b => b.toString(16).padStart(2, '0')).join('');
            const solverSkHex = Array.from(solverSk).map(b => b.toString(16).padStart(2, '0')).join('');
            
            // Create funding address with CSV refund leaf
            state.addressInfo = wasm.createRefundAddress(
                userSkHex,
                solverSkHex,
                quote.timelock,
                'regtest'
            );
            
            // Calculate amounts
            const escrowAmountBtc = state.swapAmount;
            const escrowAmountSats = Math.floor(escrowAmountBtc * 100000000);
            state.escrowAmountSats = escrowAmountSats; // Store for later use
            
            // Create Bitcoin URI
            const bitcoinUri = `bitcoin:${state.addressInfo.address}?amount=${escrowAmountBtc.toFixed(8)}`;
            
            // Display address and solver info
            document.getElementById('escrow-address').textContent = state.addressInfo.address;
            document.getElementById('send-amount').textContent = escrowAmountBtc.toFixed(5) + ' BTC';
            document.getElementById('solver-name').textContent = quote.solver;
            document.getElementById('lanebtc-receive').textContent = quote.receives;
            document.getElementById('cli-command').textContent = 
                `bitcoin-cli -regtest sendtoaddress ${state.addressInfo.address} ${escrowAmountBtc.toFixed(5)}`;
            
            // Set up Bitcoin URI link
            const uriLink = document.getElementById('bitcoin-uri-link');
            uriLink.href = bitcoinUri;
            
            // Generate QR code
            const qrContainer = document.getElementById('qr-container');
            qrContainer.innerHTML = ''; // Clear any existing QR code
            new QRCode(qrContainer, {
                text: bitcoinUri,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            document.getElementById('step-swap').classList.add('hidden');
            document.getElementById('step-address').classList.remove('hidden');
            
            console.log('‚úÖ Escrow address created:', state.addressInfo.address);
            console.log('üì± Bitcoin URI:', bitcoinUri);
            console.log('üîí Escrow amount:', escrowAmountBtc, 'BTC (', escrowAmountSats, 'sats)');
            console.log('‚è±Ô∏è CSV timelock:', quote.timelock, 'blocks');
            
            // Auto-detect deposit after 10 seconds (simulated)
            setTimeout(() => {
                autoDetectDeposit();
            }, 10000);
        };

        function autoDetectDeposit() {
            // Simulate detecting the deposit on-chain
            const txid = '2a21b7bac314996ad3f563a80887d73d4569e40d7f7d50e8ac0a07a7393e726a';
            const vout = 1;
            
            console.log('üí∞ Deposit detected!');
            console.log('   TXID:', txid);
            console.log('   Vout:', vout);
            
            state.fundingTxid = txid;
            state.fundingVout = vout;
            
            confirmFunding();
        }

        async function confirmFunding() {
            const txid = state.fundingTxid;
            const vout = state.fundingVout;
            
            // Show loading screen
            document.getElementById('step-address').classList.add('hidden');
            document.getElementById('step-loading').classList.remove('hidden');
            
            console.log('‚úÖ Funding confirmed:', txid, 'vout:', vout);
            console.log('üîÑ Collaborating with solver to create burn transaction...');
            
            // Simulate multi-step process with delays
            await simulateLoadingSteps();
            
            // Hide loading, show waiting for solver
            document.getElementById('step-loading').classList.add('hidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            
            console.log('‚è≥ Waiting for solver to fulfill intent...');
            
            // Simulate solver fulfilling the swap after 8 seconds
            setTimeout(() => {
                solverFulfilled();
            }, 8000);
        }

        function solverFulfilled() {
            console.log('‚úÖ Solver fulfilled! LaneBTC delivered to LaneLayer account');
            
            const receivedAmount = state.selectedQuote?.receives || '0.00000';
            document.getElementById('delivered-amount').textContent = receivedAmount + ' LaneBTC';
            document.getElementById('delivered-amount-2').textContent = receivedAmount + ' LaneBTC';
            
            // Show delivery confirmation
            document.getElementById('step-waiting').classList.add('hidden');
            document.getElementById('step-delivery').classList.remove('hidden');
        }

        window.completeDelivery = function() {
            console.log('ü§ù User confirmed delivery, proceeding to cooperative payout');
            cooperativePayout();
        };

        window.showDispute = function() {
            console.log('‚ö†Ô∏è User disputed delivery');
            
            // Start refund countdown
            updateRefundCountdown();
            
            // Show advanced actions (burn/refund options)
            document.getElementById('step-delivery').classList.add('hidden');
            document.getElementById('step-actions').classList.remove('hidden');
        };

        async function simulateLoadingSteps() {
            const steps = [
                { id: 'load-step-1', duration: 600, text: '‚úÖ Funding transaction verified' },
                { id: 'load-step-2', duration: 800, text: '‚úÖ MuSig2 nonces exchanged' },
                { id: 'load-step-3', duration: 900, text: '‚úÖ Burn transaction presigned' },
                { id: 'load-step-4', duration: 700, text: '‚úÖ Escrow ready' }
            ];
            
            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, step.duration));
                const el = document.getElementById(step.id);
                el.textContent = step.text;
                el.classList.add('step-done');
                console.log(step.text);
            }
        }

        function updateRefundCountdown() {
            // Mock countdown - in production, check actual block height
            const timelock = state.selectedQuote?.timelock || 144;
            document.getElementById('refund-countdown').textContent = `${timelock} blocks`;
            document.getElementById('btn-refund').disabled = true;
            document.getElementById('btn-refund').textContent = 'Locked (timelock not expired)';
        }

        window.showBurnTx = function() {
            try {
                console.log('Building burn transaction...');
                
                // Build BTI1 burn transaction
                const escrowSats = BigInt(state.escrowAmountSats);
                const burnAmount = escrowSats - 500n; // Leave 500 sat fee for demo
                
                const unsignedPsbt = wasm.buildBurnPsbt(
                    state.fundingTxid,
                    state.fundingVout,
                    escrowSats,
                    burnAmount,
                    CHAIN_ID,
                    state.intentHash,
                    'regtest'
                );
                
                console.log('‚úÖ Unsigned burn PSBT created');
                
                // Sign with MuSig2
                const userSkHex = Array.from(state.userKeys.sk).map(b => b.toString(16).padStart(2, '0')).join('');
                const solverSkHex = Array.from(state.solverKeys.sk).map(b => b.toString(16).padStart(2, '0')).join('');
                
                const signedTx = wasm.signBurnPsbtDemo(
                    userSkHex,
                    solverSkHex,
                    unsignedPsbt.hex,
                    state.addressInfo.address,
                    escrowSats,
                    state.addressInfo.merkle_root_hex || '',
                    state.addressInfo.internal_key || '',
                    state.addressInfo.output_key || ''
                );
                
                console.log('‚úÖ Burn transaction signed');
                
                // Display results
                document.getElementById('burn-hex').textContent = signedTx.hex;
                document.getElementById('burn-txid').textContent = signedTx.txid;
                document.getElementById('burn-intent-hash').textContent = state.intentHash;
                document.getElementById('burn-amount').textContent = (Number(burnAmount)).toLocaleString();
                document.getElementById('burn-broadcast').textContent = 
                    `bitcoin-cli -regtest sendrawtransaction ${signedTx.hex}`;
                
                document.getElementById('step-actions').classList.add('hidden');
                document.getElementById('burn-result').classList.remove('hidden');
                
            } catch (e) {
                console.error('Error building burn:', e);
                alert('Error: ' + e.message);
            }
        };

        window.cooperativePayout = async function() {
            try {
                console.log('ü§ù Starting cooperative payout...');
                
                // For demo, we'll use a solver address (in production, this comes from solver)
                const solverAddress = 'bcrt1q...solver...'; // Placeholder
                
                // In a real scenario, you'd get the solver's actual address
                // For demo purposes, let's just show the process
                
                // Build payout PSBT
                const escrowSats = BigInt(state.escrowAmountSats);
                const payoutAmount = escrowSats - 500n; // Leave 500 sat fee
                
                const unsignedPsbt = wasm.buildPayoutPsbt(
                    state.fundingTxid,
                    state.fundingVout,
                    escrowSats,
                    state.addressInfo.address, // Placeholder - should be solver's address
                    payoutAmount
                );
                
                console.log('‚úÖ Unsigned payout PSBT created');
                
                // Sign with MuSig2
                const userSkHex = Array.from(state.userKeys.sk).map(b => b.toString(16).padStart(2, '0')).join('');
                const solverSkHex = Array.from(state.solverKeys.sk).map(b => b.toString(16).padStart(2, '0')).join('');
                
                const signedTx = wasm.signPayoutPsbtDemo(
                    userSkHex,
                    solverSkHex,
                    unsignedPsbt.hex,
                    state.addressInfo.address,
                    escrowSats,
                    state.addressInfo.merkle_root_hex || '',
                    state.addressInfo.internal_key || '',
                    state.addressInfo.output_key || ''
                );
                
                console.log('‚úÖ Payout transaction signed');
                
                // Display results
                document.getElementById('payout-hex').textContent = signedTx.hex;
                document.getElementById('payout-txid').textContent = signedTx.txid;
                document.getElementById('payout-amount').textContent = (Number(payoutAmount)).toLocaleString();
                document.getElementById('payout-broadcast').textContent = 
                    `bitcoin-cli -regtest sendrawtransaction ${signedTx.hex}`;
                
                document.getElementById('step-actions').classList.add('hidden');
                document.getElementById('payout-result').classList.remove('hidden');
                
            } catch (e) {
                console.error('Error building payout:', e);
                alert('Error: ' + e.message);
            }
        };

        window.forceRefund = function() {
            document.getElementById('step-actions').classList.add('hidden');
            document.getElementById('refund-result').classList.remove('hidden');
        };

        window.copy = function(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => { btn.textContent = orig; }, 2000);
            }).catch(err => alert('Copy failed: ' + err));
        };

        // Initialize
        loadWasm();
        
        // Load initial quotes
        updateQuotes();
    </script>
</body>
</html>
